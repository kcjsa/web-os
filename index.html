<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Browser Linux OS</title>
<style>
  body { margin:0; background:#000; color:#0f0; font-family:monospace; }
  #terminal { padding:10px; white-space:pre; height:90vh; overflow-y:auto; }
  input { position:fixed; bottom:0; width:100%; background:#000; color:#0f0; border:none; outline:none; font-family:monospace; }
</style>
</head>
<body>
<div id="terminal"></div>
<input id="input" autofocus placeholder="Type commands...">
<script>
const term = document.getElementById("terminal");
const input = document.getElementById("input");

// 設定管理
const config = {
  load(){ return JSON.parse(localStorage.getItem("osConfig") || "{}"); },
  save(data){ localStorage.setItem("osConfig", JSON.stringify(data)); }
};
let osConfig = config.load();

// RAM仮想FS（多階層対応）
const virtualFS = {
  fs: { "/": {} },

  _getNode(path, create=false){
    const parts = path.split("/").filter(p=>p);
    let node = this.fs["/"];
    for(const part of parts){
      if(!node[part]){
        if(create) node[part]={};
        else return null;
      }
      node = node[part];
    }
    return node;
  },

  mkdir(path){ this._getNode(path, true); },

  list(path="/"){
    const node = this._getNode(path);
    if(!node) return "No such directory";
    return Object.keys(node).join(" ");
  },

  write(path, content){
    const parts = path.split("/").filter(p=>p);
    const fileName = parts.pop();
    const dir = this._getNode(parts.join("/"), true);
    dir[fileName] = { content };
  },

  read(path){
    const parts = path.split("/").filter(p=>p);
    const fileName = parts.pop();
    const dir = this._getNode(parts.join("/"));
    if(!dir || !dir[fileName] || !dir[fileName].content) return "No such file";
    return dir[fileName].content;
  }
};

// SSDフォルダ handles
let diskHandle = null;
let swapHandle = null;

// フォルダ選択 → disk / swap 自動作成
async function pickRootFolder(){
    const rootHandle = await window.showDirectoryPicker();
    diskHandle = await rootHandle.getDirectoryHandle("disk", { create:true });
    swapHandle = await rootHandle.getDirectoryHandle("swap", { create:true });
    draw("Disk and Swap folders created inside selected folder.");
}

// RAM使用量監視 → swap退避
async function checkRamAndSwap(){
    const used = performance.memory ? performance.memory.usedJSHeapSize : 0;
    const MAX_RAM = 1.4*1024*1024*1024;
    if(used > MAX_RAM*0.9 && swapHandle){
        for(const path in virtualFS.fs){
            const content = virtualFS.read(path);
            const fileHandle = await swapHandle.getFileHandle(path, { create:true });
            const writable = await fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
            delete virtualFS.fs[path];
            draw(`Swapped ${path} to swap folder.`);
        }
    }
}

// コマンド実装
async function executeCommand(inputStr){
    const [cmd, ...args] = inputStr.trim().split(" ");
    switch(cmd){
        case "ls": return virtualFS.list(args[0]||"/");
        case "cat": return virtualFS.read(args[0]);
        case "mkdir": virtualFS.mkdir(args[0]); return;
        case "touch": virtualFS.write(args[0],""); return;
        case "rm":
            const parts = args[0].split("/").filter(p=>p);
            const fileName = parts.pop();
            const dir = virtualFS._getNode(parts.join("/"));
            if(dir && dir[fileName]) delete dir[fileName];
            return;
        case "echo": return args.join(" ");
        case "pwd": return "/";
        case "clear": term.textContent=""; return;
        case "help": return "Commands: ls, cat, mkdir, touch, rm, echo, pwd, clear, reboot, diskls, diskcat, pickdisk, ramusage";
        case "reboot":
            draw("System rebooting...");
            setTimeout(() => location.reload(), 500);
            return;
        case "pickdisk":
            await pickRootFolder(); return;
        case "diskls":
            if(!diskHandle) return "Disk folder not selected";
            const files=[];
            for await(const [name] of diskHandle.entries()){ files.push(name); }
            return files.join(" ");
        case "diskcat":
            if(!diskHandle) return "Disk folder not selected";
            if(!args[0]) return "Specify file";
            const fileHandle = await diskHandle.getFileHandle(args[0]);
            const file = await fileHandle.getFile();
            return await file.text();
        case "ramusage":
            return "RAM usage: approx "+(performance.memory?Math.round(performance.memory.usedJSHeapSize/1024/1024):"N/A")+" MB";
        default: return cmd+": command not found";
    }
}

// 表示補助
function draw(text){ term.textContent += text+"\n"; term.scrollTop = term.scrollHeight; }

// 入力処理
input.addEventListener("keydown", async(e)=>{
  if(e.key==="Enter"){
    const cmd = input.value;
    draw("> "+cmd);
    input.value="";
    const res = await executeCommand(cmd);
    if(res!==undefined) draw(res);
    await checkRamAndSwap();
  }
});

draw("Browser Linux OS (sh) ready. Type 'help'. Use 'pickdisk' to select folder.");
</script>
</body>
</html>
