<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Browser Linux OS</title>
<style>
body { margin:0; background:#000; color:#0f0; font-family:monospace; }
#terminal { padding:10px; white-space:pre; height:90vh; overflow-y:auto; }
input { position:fixed; bottom:0; width:100%; background:#000; color:#0f0; border:none; outline:none; font-family:monospace; }
</style>
</head>
<body>
<div id="terminal"></div>
<input id="input" autofocus placeholder="Type commands...">
<script>
const term = document.getElementById("terminal");
const input = document.getElementById("input");

// RAM仮想FS（単階層）
const virtualFS = {};

// SSDフォルダ handles
let diskHandle = null;
let swapHandle = null;

// 表示補助
function draw(text){ term.textContent += text+"\n"; term.scrollTop = term.scrollHeight; }

// フォルダ選択 → disk / swap 自動作成
async function pickRootFolder(){
    const rootHandle = await window.showDirectoryPicker();
    diskHandle = await rootHandle.getDirectoryHandle("disk", { create:true });
    swapHandle = await rootHandle.getDirectoryHandle("swap", { create:true });
    draw("Disk and Swap folders created inside selected folder.");
}

// RAM使用量監視 → swap退避（単純例）
async function checkRamAndSwap(){
    const used = performance.memory ? performance.memory.usedJSHeapSize : 0;
    const MAX_RAM = 1.4*1024*1024*1024;
    if(used > MAX_RAM*0.9 && swapHandle){
        for(const name in virtualFS){
            const content = virtualFS[name];
            try{
                const fileHandle = await swapHandle.getFileHandle(name, { create:true });
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                delete virtualFS[name];
                draw(`Swapped ${name} to swap folder.`);
            }catch(e){ draw("Swap failed: "+name); }
        }
    }
}

// コマンド実装
async function executeCommand(inputStr){
    const [cmd, ...args] = inputStr.trim().split(" ");
    switch(cmd){
        case "ls": return Object.keys(virtualFS).join(" ") || "(empty)";
        case "cat": return virtualFS[args[0]] || "No such file";
        case "mkdir": virtualFS[args[0]] = {}; return;
        case "touch": virtualFS[args[0]] = ""; return;
        case "rm": if(args[0] in virtualFS) delete virtualFS[args[0]]; return;
        case "echo": return args.join(" ");
        case "pwd": return "/";
        case "clear": term.textContent=""; return;
        case "help": return "Commands: ls, cat, mkdir, touch, rm, echo, pwd, clear, reboot, diskls, diskcat, pickdisk, ramusage";
        case "reboot": draw("System rebooting..."); setTimeout(()=>location.reload(),500); return;
        case "pickdisk": await pickRootFolder(); return;
        case "diskls":
            if(!diskHandle) return "Disk folder not selected";
            const files=[];
            for await(const [name] of diskHandle.entries()){ files.push(name); }
            return files.join(" ");
        case "diskcat":
            if(!diskHandle) return "Disk folder not selected";
            if(!args[0]) return "Specify file";
            try{
                const fileHandle = await diskHandle.getFileHandle(args[0]);
                const file = await fileHandle.getFile();
                return await file.text();
            }catch(e){ return "File not found"; }
        case "ramusage": return "RAM usage: approx "+(performance.memory?Math.round(performance.memory.usedJSHeapSize/1024/1024):"N/A")+" MB";
        default: return cmd+": command not found";
    }
}

// 入力処理
input.addEventListener("keydown", async(e)=>{
  if(e.key==="Enter"){
    const cmd = input.value;
    draw("> "+cmd);
    input.value="";
    const res = await executeCommand(cmd);
    if(res!==undefined) draw(res);
    await checkRamAndSwap();
  }
});

draw("Browser Linux OS (sh) ready. Type 'help'. Use 'pickdisk' to select folder.");
</script>
</body>
</html>
