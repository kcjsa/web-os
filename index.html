<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Browser Linux OS Complete</title>
<style>
body { margin:0; background:#000; color:#0f0; font-family:monospace; }
#terminal { padding:10px; white-space:pre; height:90vh; overflow-y:auto; }
input { position:fixed; bottom:0; width:100%; background:#000; color:#0f0; border:none; outline:none; font-family:monospace; }
</style>
</head>
<body>
<div id="terminal"></div>
<input id="input" autofocus placeholder="Type commands...">
<script>
const term = document.getElementById("terminal");
const input = document.getElementById("input");

// 単階層RAM FS
const virtualFS = {};

// SSDフォルダ handles
let diskHandle = null;
let swapHandle = null;

// 表示補助
function draw(text){ term.textContent += text+"\n"; term.scrollTop = term.scrollHeight; }

// pickdisk → disk/swapフォルダ作成
async function pickRootFolder(){
    try {
        const rootHandle = await window.showDirectoryPicker();
        diskHandle = await rootHandle.getDirectoryHandle("disk", { create:true });
        swapHandle = await rootHandle.getDirectoryHandle("swap", { create:true });
        draw("Disk and Swap folders created in selected folder.");
    } catch(e){
        draw("Folder selection canceled or denied.");
    }
}

// RAM使用量監視 → swap退避（簡易版）
async function checkRamAndSwap(){
    if(!swapHandle) return;
    const MAX_RAM = 1.4*1024*1024*1024;
    const used = performance.memory ? performance.memory.usedJSHeapSize : 0;
    if(used > MAX_RAM*0.9){
        for(const name in virtualFS){
            try{
                const fileHandle = await swapHandle.getFileHandle(name, { create:true });
                const writable = await fileHandle.createWritable();
                await writable.write(virtualFS[name]);
                await writable.close();
                delete virtualFS[name];
                draw(`Swapped ${name} to swap folder.`);
            } catch(e){ draw("Swap failed: "+name); }
        }
    }
}

// コマンド処理（30種類＋α）
async function executeCommand(inputStr){
    const [cmd, ...args] = inputStr.trim().split(/\s+/);
    switch(cmd){
        case "ls": return Object.keys(virtualFS).join(" ") || "(empty)";
        case "cat": return args[0] ? (virtualFS[args[0]] ?? "No such file") : "Specify file";
        case "mkdir": 
            if(!args[0]) return "Specify directory name";
            virtualFS[args[0]]={}; return;
        case "touch":
            if(!args[0]) return "Specify file name";
            virtualFS[args[0]]=""; return;
        case "rm":
            if(!args[0]) return "Specify target";
            if(args[0] in virtualFS) delete virtualFS[args[0]]; return;
        case "echo": return args.join(" ");
        case "pwd": return "/";
        case "clear": term.textContent=""; return;
        case "help": return `Commands:
ls, cat, mkdir, touch, rm, echo, pwd, clear, reboot, pickdisk, diskls, diskcat, ramusage,
date, whoami, uname, uptime, df, du, top, ps, kill, reboot, shutdown, hostname, ping, curl, wget, man`;
        case "reboot": draw("System rebooting..."); setTimeout(()=>location.reload(),500); return;
        case "pickdisk": await pickRootFolder(); return;
        case "diskls":
            if(!diskHandle) return "Disk folder not selected";
            const files = [];
            for await(const [name] of diskHandle.entries()) files.push(name);
            return files.join(" ");
        case "diskcat":
            if(!diskHandle) return "Disk folder not selected";
            if(!args[0]) return "Specify file";
            try{
                const fileHandle = await diskHandle.getFileHandle(args[0]);
                const file = await fileHandle.getFile();
                return await file.text();
            }catch(e){ return "File not found"; }
        case "ramusage": return "RAM usage: approx "+(performance.memory?Math.round(performance.memory.usedJSHeapSize/1024/1024):"N/A")+" MB";
        case "date": return new Date().toString();
        case "whoami": return "guest";
        case "uname": return navigator.userAgent;
        case "uptime": return "Uptime unavailable in browser";
        case "df": return "Filesystem info unavailable in browser";
        case "du": return "Directory usage unavailable";
        case "top": return "Browser OS cannot show process list";
        case "ps": return "No processes in browser environment";
        case "kill": return "Cannot kill processes in browser";
        case "shutdown": draw("Shutting down..."); setTimeout(()=>location.reload(),500); return;
        case "hostname": return "browser-os";
        case "ping": return args[0] ? `Pinging ${args[0]} ... timeout` : "Specify host";
        case "curl": return args[0] ? `Fetched ${args[0]} ...` : "Specify URL";
        case "wget": return args[0] ? `Downloaded ${args[0]} ...` : "Specify URL";
        case "man": return "Manual unavailable"; 
        default: return cmd+": command not found";
    }
}

// 入力処理
input.addEventListener("keydown", async(e)=>{
    if(e.key==="Enter"){
        const cmd = input.value;
        draw("> "+cmd);
        input.value="";
        const res = await executeCommand(cmd);
        if(res!==undefined) draw(res);
        await checkRamAndSwap();
    }
});

draw("Browser Linux OS (sh) ready. Type 'help'. Use 'pickdisk' to select folder.");
</script>
</body>
</html>
